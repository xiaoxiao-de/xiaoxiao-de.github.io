---
title: 小程序
date: 2022/08/07 20:48:01
tags: [小程序]
categories: 技术
cover: static\img\ok.jpg
---
### 小程序地图功能

```
// 小程序内置了一个地图组件map用于展示地图
 <map
   style="width: 100%; height: 100vh" 
   :latitude="points.latitude" // 纬度
   :longitude="points.longitude"  // 经度
   :markers="covers" // 地图中自定义图标点
   id="map1"
   ref="map1"
   show-location
   @markertap='showMaker'> // 图标点击事件
 </map>
```

```
// js
// 点击地图时获取用户权限,权限获取失败提醒用户是否授权位置
 async findWC() {
   let that = this
   try{
     await this.getWxlocation() // 调用地图定位方法进行定位
	 setTimeout(() => { // 进入地图时获取附近建筑点由于使用了async,awitch
	   this.getMapData() // 这边采用定时器创建一个宏任务使该方法能正常调用
	 },1500)
	 }catch(err){
	  // 用户没有授权时提醒用户
	   uni.showModal({
	     title: `温馨提示`,
		 content: '获取权限失败,需要获取您的地理位置才能更好的为您服务!,是否授权地理位置?',
		 showCancel: true,
		 cancelText: '取消',
		 confirmText: '前往设置',
		 success({confirm,cancel}){
		   if(confirm){
		     that.toSetting() // 用户点击前往设置需要授权时调用权限面板
		     return
		   }
		   if(cancel){
		     uni.showToast({
			   title: `取消授权`,
			   icon: 'none'
			})
			}
			},
			 fail(){}
			    })
			  }
			}
			点击时获得自己的位置并发送请求给后端查询附近的建筑点
// 调用用户手机授权面板获取位置权限
  toSetting(){
    let that = this
	uni.openSetting({
	  success(res){
	  // 判断用户是否选中地图权限
	    if(res.authSetting['scope.userLocation']){
	      uni.showToast({
		  title: '授权成功',
		  icon: 'none'
		})
	    }
		}  
		})
	 }
// 地图定位
getWxlocation(){
  let that = this
  uni.showLoading({
    title: '定位中...',
	mask: true
  })
  // 采用promise对获取位置进行封装
  return new Promise((resolve, reject) => {
    const locationChange = (res) => {
	  that.points.latitude = res.latitude // 获取返回来的经纬度
      that.points.longitude = res.longitude
	  uni.hideLoading() // 隐藏加载动画
	  wx.offLocationChange(locationChange) // 解除绑定
	  that.flag = true 
	  }
	  // 获取位置
		wx.startLocationUpdate({
		  success(res){
		    wx.onLocationChange(locationChange)
			resolve()
		 },
		  fail(err){
		    uni.showToast({
			  title: `获取位置失败${err}`,
			  icon: 'none'
			})
			uni.hideLoading()
			reject()
			}
		   })
		   })
		}
```

